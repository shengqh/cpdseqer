---
title: "CPDsequer Analysis Report"
date: "`r format(Sys.time())`"
output: 
  html_document:
    toc: true
    toc_depth: 4
    number_sections: true
params:
  db: hg38
---

<style type="text/css">
.main-container {
  max-width: 90%;
  margin-left: auto;
  margin-right: auto;
}
</style>
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r init, include=FALSE}

## parameters
hg19 = (params$db=="hg19") ## default
hg38 = (! hg19)
plot.pos = TRUE
plot.mut = TRUE
ctrl.default = FALSE

library(knitr) ## kable
library(data.table) ## fread
library(dplyr)
library(ggplot2)
library(reshape2) ## acast

samples <- read.delim("dinucleotide_file.list", sep = '\t', header = F, stringsAsFactors = F)

if(nrow(samples) == 0) {
  stop("No data in dinucleotide_file.list")
}

colnames(samples)<-c("File", "Name", "Group")
if(!all(samples$Group %in% c(0, 1))){
  stop("Group should be either 0 for control or 1 for case in dinucleotide_file.list")
}

```


# Genomic positions plot

```{r genomic, echo=FALSE, results='asis'}

level.chr <- c('chr1', 'chr2', 'chr3', 'chr4', 'chr5', 'chr6', 'chr7', 'chr8', 'chr9', 'chr10', 'chr11', 'chr12', 'chr13', 'chr14', 'chr15', 'chr16', 'chr17', 'chr18', 'chr19', 'chr20', 'chr21', 'chr22', 'chrX', 'chrY')
level.mut <- c('AA', 'AC', 'AG', 'AT', 'CA', 'CC', 'CG', 'CT', 'GA', 'GC', 'GG', 'GT', 'TA', 'TC', 'TG', 'TT')

if(hg19 == T){
  info <- read.delim("chromInfo_hg19.txt", sep = "\t", header = TRUE)
}else if(hg38 == T){
  info <- read.delim("chromInfo_hg38.txt", sep = "\t", header = FALSE)
}else{
  stop("Please set up GRCh version")
}
colnames(info)<-c(paste0("V", c(1:ncol(info))))
info <- info[info$V1 %in% level.chr, c("V1", "V2")]
info <- data.frame(chrom = factor(info$V1, levels = rev(level.chr)),
                   chromStart = rep(0, nrow(info)),
                   chromEnd = info$V2)

## cases plot
i<-1
cnt.all <- NULL
for (i in 1:nrow(samples)) {
  sampleFile <- samples$File[i]
  sampleName <- samples$Name[i]
  sampleGroup <- samples$Group[i]

  cat(paste0("\n\n## ", sampleName, "\n\n"))

  case <- fread(sampleFile, sep = "\t", header = F, data.table = F, stringsAsFactors = F)
  case <- case[case$V1 %in% level.chr,]
  chroms<-level.chr[level.chr %in% case$V1]
  chroms<-rev(chroms)
  case$V1<-factor(case$V1, levels=chroms)

  if(plot.pos){
    cat(paste0("\n\n### ", sampleName, " Genomic positions plot\n\n"))

    seg <- ggplot()+
      geom_segment(data = info,
                   aes(y = chrom, yend = chrom, x = chromStart, xend = chromEnd),
                   lineend = "round", color = "Gainsboro", size = 5)+
      geom_segment(data = case,
                   aes(y = V1, yend = V1, x = V2, xend = V3, color=V4),
                   lineend = "butt", size = 5)+
      scale_color_gradient(high="DimGray",low="Gainsboro") +
      scale_x_continuous(limits = c(0, 250e6),
                         expand = c(0, 2e6), ## expand dist = (maxlimit-minlimit)*a + b
                         breaks = seq(0, 250e6, by = 50e6),
                         labels = paste0(seq(0, 250, by = 50), "Mb"),
                         position = "top")+
      theme_minimal()+
      theme(panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            plot.margin = margin(0.1, 10, 0.1, 0.1, "pt"))+
      labs(x = "Genomic positions", y = NULL)
    print(seg)
  }
}

```
  }

  cnt.i <- case %>% count(V1, V4)
  colnames(cnt.i)<-c("Chrom", "Dinucleotide", "Count")
  cnt.i$Sample = sampleName
  cnt.i$Group = sampleGroup
  cnt.all <- rbind(cnt.all, cnt.i)

  if(plot.mut){
    df <- acast(cnt.i, factor(Dinucleotide, levels = level.mut)~factor(Chrom, levels = level.chr), value.var = "Count", fun.aggregate = sum)
    df[is.na(df)] <- 0
    df <- cbind(df, total = apply(df, 1, sum))
    df <- apply(df, 2, function(x) x/sum(x))

    lab <- rownames(df)
    lab.pos <- cumsum(df[,1]) - df[,1]/2

    df <- melt(df)
    colnames(df) <- c("mut", "chrom", "value")

    cat(paste0("\n\n### ", sampleName, " mutation proportion plot\n\n"))

    bar <- ggplot(df, aes(x = factor(chrom, levels = rev(c(level.chr, "total"))),
                          y = value,
                          fill = factor(mut, levels = rev(level.mut))))+
      geom_bar(color = "black", stat = "identity", width = 0.8)+
      annotate(geom = "text", x = Inf, y = lab.pos, label = lab, size = 4) +
      labs(x = NULL, y = NULL, title = NULL)+
      scale_y_continuous(expand = c(0.01,0),
                         labels = scales::percent)+
      scale_x_discrete(expand = c(0.035, 0))+
      scale_fill_manual(values = rep(c("white", "Gainsboro"), 8), drop=FALSE)+
      theme_void()+
      theme(axis.text = element_text(size = 10),
            plot.margin = margin(20, 10, 2, 2, unit = "pt"),
            legend.position = "none")+
      coord_flip(clip = "off")
    print(bar)
  }
}

sample.cnt.aggr <- data.frame(aggregate(data = cnt.all, Count ~ Group + Dinucleotide, FUN = sum))


```


# Binomial Test

```{r binomial, echo=FALSE, results='asis'}

case.cnt<-sample.cnt.aggr[sample.cnt.aggr$Group==1,]
rownames(case.cnt)<-case.cnt$Dinucleotide
ctrl.cnt<-sample.cnt.aggr[sample.cnt.aggr$Group==0,]
rownames(ctrl.cnt)<-ctrl.cnt$Dinucleotide
ctrl.cnt$Proportion <- unlist(lapply(ctrl.cnt$Count, function(x) x/sum(ctrl.cnt$Count)))

## Binomial Test
res.bit <- data.frame(matrix(nrow = nrow(case.cnt), ncol = 0))
for (i in 1:nrow(case.cnt)) {
  mut <- rownames(case.cnt)[i]
  bit <- tryCatch(binom.test(case.cnt[mut, 'Count'], sum(case.cnt[, 'Count']), p = ctrl.cnt[mut, 'Proportion']),
                  error = function(e) return(NA))
  if(!is.na(bit)[1]){
    res.bit$Mut[i] <- mut
    res.bit$Proportion[i] <- bit$estimate
    res.bit$Expected[i] <- bit$null.value
    res.bit$pvalue[i] <- bit$p.value
    res.bit$`0.95CI`[i] <- paste0('[', round(bit$conf.int[1], 4), ';', round(bit$conf.int[2], 4), ']')
  }else{
    res.bit$Mut[i] <- mut
    res.bit$Proportion[i] <- case.cnt[mut, 'Count']/sum(case.cnt[, 'Count'])
    res.bit$Expected[i] <- ctrl.cnt[mut, 'Count']
    res.bit$pvalue[i] <- NA
    res.bit$`0.95CI`[i] <- NA
  }
}
cat("\n\n## Binomial Test Result\n\n")
kable(res.bit, caption = NULL)
```
